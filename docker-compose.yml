version: "3.8"

# ============================================================
# acme-reloader - 完整的 acme.sh 证书自动化解决方案
# ============================================================
#
# 这是一个开箱即用的配置文件
# 运行 sudo ./install.sh 后直接使用 docker-compose up -d 启动

services:
  acme.sh:
    image: neilpang/acme.sh:latest
    container_name: acme.sh
    restart: always
    command: daemon
    volumes:
      # SSL 证书存储目录 - 证书将保存在这里
      - ./ssl:/ssl

      # acme.sh 配置目录 - 存储账号信息和证书配置
      - ./acme-config:/acme.sh

      # Socket 通信目录 - 用于与宿主机 acme-reloader-host 通信
      # 这是核心：通过这个目录实现容器到宿主机的通知
      - ./acme-reloader:/acme-reloader

      # 挂载客户端脚本 - 容器内调用这个脚本通知宿主机
      - ./bin/acme-reloader.sh:/acme-reloader.sh:ro

      # 挂载库文件 - 脚本依赖的库
      - ./lib:/acme-reloader-lib:ro

    environment:
      # 可选：自定义 socket 路径（如果你修改了配置文件）
      # - ACME_RELOADER_SOCKET=/acme-reloader/socket/acme-reloader.sock

      # 可选：自定义超时时间
      # - ACME_RELOADER_TIMEOUT=30

      # acme.sh 相关环境变量
      # 如果使用 DNS API 验证，在这里配置你的 API 密钥
      # Cloudflare 示例:
      # - CF_Token=your_cloudflare_api_token
      # - CF_Zone_ID=your_zone_id

      # DNSPod 示例:
      # - DP_Id=your_dnspod_id
      # - DP_Key=your_dnspod_key
      - DOCKER_MODE=true

# ============================================================
# 使用说明
# ============================================================
#
# 前置条件：
# 1. 已运行 sudo ./install.sh 完成安装
# 2. acme-reloader-host 服务正在运行
#    检查: sudo systemctl status acme-reloader-host
#
# ============================================================
# 快速开始
# ============================================================
#
# 1. 启动容器
#    docker-compose up -d
#
# 2. 进入容器
#    docker exec -it acme.sh ash
#
# 3. 注册账号（首次使用）
#    acme.sh --register-account -m your@email.com
#    acme.sh --set-default-ca --server letsencrypt
#
# 4. 申请证书（DNS 验证示例 - Cloudflare）
#    # 方法1：使用环境变量（推荐）
#    export CF_Token="your_token"
#    export CF_Zone_ID="your_zone_id"
#    acme.sh --issue -d example.com -d *.example.com --dns dns_cf
#
#    # 方法2：使用其他 DNS 提供商
#    # 查看支持的DNS: acme.sh --help dns
#
# 5. 安装证书并配置自动重载（重要！）
#    acme.sh --install-cert -d example.com \
#      --cert-file /ssl/example.com/cert.pem \
#      --key-file /ssl/example.com/key.pem \
#      --fullchain-file /ssl/example.com/fullchain.pem \
#      --reloadcmd "bash /acme-reloader.sh"
#
# 6. 配置你的 Web 服务器
#    证书文件在宿主机的 ./ssl/ 目录下
#
#    Nginx 配置示例:
#      ssl_certificate /path/to/acme-reloader/ssl/example.com/fullchain.pem;
#      ssl_certificate_key /path/to/acme-reloader/ssl/example.com/key.pem;
#
# 7. 完成！
#    证书会自动续签，续签后自动执行你配置的重启命令
#
# ============================================================
# 故障排查
# ============================================================
#
# 问题：容器启动失败
#   docker-compose logs acme.sh
#
# 问题：无法通知宿主机重载
#   1. 检查宿主机服务: sudo systemctl status acme-reloader-host
#   2. 检查 socket: ls -la ./acme-reloader/socket/
#   3. 手动测试: docker exec acme.sh bash /acme-reloader.sh
#   4. 查看日志: tail -f ./logs/acme-reloader.log
#
# 问题：证书申请失败
#   1. 检查 DNS API 配置是否正确
#   2. 在容器内查看详细日志: acme.sh --issue ... --debug
#   3. 检查域名解析是否正常
#
# 问题：证书路径问题
#   容器内路径: /ssl/
#   宿主机路径: ./ssl/  (相对于 docker-compose.yml)
#
# ============================================================
# 高级配置
# ============================================================
#
# 如果你的 Nginx 也在 Docker 中运行：
#
# 1. 修改 config/config.yml 中的重启命令为:
#    command: "docker exec nginx nginx -s reload"
#
# 2. 证书需要同时挂载到 Nginx 容器:
#    在 Nginx 的 docker-compose.yml 中添加:
#    volumes:
#      - ./ssl:/etc/nginx/ssl:ro
#
# 3. Nginx 配置使用容器内路径:
#    ssl_certificate /etc/nginx/ssl/example.com/fullchain.pem;
#    ssl_certificate_key /etc/nginx/ssl/example.com/key.pem;
#
# ============================================================
# 更多信息
# ============================================================
#
# - acme.sh 官方文档: https://github.com/acmesh-official/acme.sh
# - 项目文档: ./README.md
# - 故障排查: ./docs/TROUBLESHOOTING.md
